--!strict

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local Shared = ReplicatedStorage:WaitForChild("Shared")
local Packages = require(Shared.Packages)
local Packet = Packages.Packet

local IsServer = RunService:IsServer()
local DEFAULT_RADIUS = 100

local function FireNearby(PacketObj: any, Position: Vector3, Radius: number?, ...: any)
	if not IsServer then
		return
	end

	local Range = Radius or DEFAULT_RADIUS

	for _, Player in Players:GetPlayers() do
		local Character = Player.Character
		if not Character then
			continue
		end

		local Root = Character:FindFirstChild("HumanoidRootPart") :: BasePart?
		if not Root then
			continue
		end

		if (Root.Position - Position).Magnitude <= Range then
			PacketObj:FireClient(Player, ...)
		end
	end
end

local function FireExcept(PacketObj: any, ExcludedPlayer: Player, ...: any)
	if not IsServer then
		return
	end

	for _, Player in Players:GetPlayers() do
		if Player ~= ExcludedPlayer then
			PacketObj:FireClient(Player, ...)
		end
	end
end

local function FireList(PacketObj: any, PlayerList: { Player }, ...: any)
	if not IsServer then
		return
	end

	for _, Player in PlayerList do
		PacketObj:FireClient(Player, ...)
	end
end

return {
	FireNearby = FireNearby,
	FireExcept = FireExcept,
	FireList = FireList,

	EntitySpawned = Packet(
		"EntitySpawned",
		Packet.Instance,
		{ Stats = Packet.Any, States = Packet.Any }
	),

	EntityDespawned = Packet(
		"EntityDespawned",
		Packet.Instance
	),

	DamageDealt = Packet(
		"DamageDealt",
		Packet.Instance,
		Packet.NumberF32,
		Packet.Vector3F32,
		Packet.Boolean8
	),

	StatChanged = Packet(
		"StatChanged",
		Packet.String,
		Packet.NumberF32,
		Packet.NumberF32
	),

	StateChanged = Packet(
		"StateChanged",
		Packet.String,
		Packet.Boolean8
	),

	PlaySound = Packet(
		"PlaySound",
		Packet.String,
		Packet.Any,
		Packet.Any
	),

	PlayMusic = Packet(
		"PlayMusic",
		Packet.String,
		Packet.Any
	),

	StopMusic = Packet(
		"StopMusic",
		Packet.Any
	),

	SpawnEffect = Packet(
		"SpawnEffect",
		Packet.String,
		Packet.Vector3F32,
		Packet.Any
	),

	SettingsSync = Packet(
		"SettingsSync",
		Packet.Any
	),

	SettingChanged = Packet(
		"SettingChanged",
		Packet.String,
		Packet.Any
	),

	FetchData = Packet(
		"FetchData",
		Packet.String,
		Packet.String
	),

	DataResponse = Packet(
		"DataResponse",
		Packet.String,
		Packet.Boolean8,
		Packet.Any
	),

	-- Action PACKETS
    ActionActivate = Packet(
        "ActionActivate",
        Packet.String,
        Packet.NumberF64
    ),

    ActionCancel = Packet(
        "ActionCancel",
        Packet.String
    ),

    ActionRejected = Packet(
        "ActionRejected",
        Packet.String,
        Packet.String
    ),

    ActionSync = Packet(
        "ActionSync",
        Packet.String,
        Packet.String,
        Packet.Boolean8
    ),

	HitCandidates = Packet(
		"HitCandidates",
		Packet.String,      -- ActionId
		Packet.String,      -- TargetName
		Packet.NumberF32,   -- Damage
		Packet.NumberF32,   -- Stun
		Packet.String,      -- AttackType
		Packet.Boolean8,    -- Blockable
		Packet.Boolean8,    -- Block360
		Packet.Boolean8,    -- CancelEnemy
		Packet.NumberF64    -- Timestamp
	),

    HitConfirmed = Packet(
        "HitConfirmed",
        Packet.Instance,
        Packet.Instance,
        Packet.NumberF32,
        Packet.Vector3F32,
        Packet.String
    ),

    CooldownStarted = Packet(
        "CooldownStarted",
        Packet.String,
        Packet.NumberF32
    ),

    ConnectSignal = Packet(
        "ConnectSignal",
        Packet.String,
        Packet.Vector3F32,
        Packet.NumberF32,
        Packet.NumberF32
    ),

	--PLAYER ActionS
    PlayerActionCreate = Packet(
        "PlayerActionCreate",
        Packet.Any                  -- RawAction table
    ),

    PlayerActionCreateResult = Packet(
        "PlayerActionCreateResult",
        Packet.Boolean8,            -- Success
        Packet.String               -- ActionId or ErrorReason
    ),

    PlayerActionUpdate = Packet(
        "PlayerActionUpdate",
        Packet.Any                  -- RawAction table
    ),

    PlayerActionUpdateResult = Packet(
        "PlayerActionUpdateResult",
        Packet.Boolean8,            -- Success
        Packet.String               -- ActionId or ErrorReason
    ),

    PlayerActionDelete = Packet(
        "PlayerActionDelete",
        Packet.String               -- ActionId
    ),

    PlayerActionDeleteResult = Packet(
        "PlayerActionDeleteResult",
        Packet.Boolean8,            -- Success
        Packet.String               -- ActionId or ErrorReason
    ),

    PlayerActionEquip = Packet(
        "PlayerActionEquip",
        Packet.String               -- ActionId
    ),

    PlayerActionEquipResult = Packet(
        "PlayerActionEquipResult",
        Packet.Boolean8,            -- Success
        Packet.String               -- ActionId or ErrorReason
    ),

    PlayerActionUnequip = Packet(
        "PlayerActionUnequip",
        Packet.String               -- ActionId
    ),

    PlayerActionSync = Packet(
        "PlayerActionSync",
        Packet.Any                  -- { [ActionId]: ActionData }
    ),

    PlayerActionAdded = Packet(
        "PlayerActionAdded",
        Packet.String,              -- ActionId
        Packet.Any                  -- ActionData
    ),

    PlayerActionRemoved = Packet(
        "PlayerActionRemoved",
        Packet.String               -- ActionId
    ),
}